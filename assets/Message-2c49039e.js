import{r as A,i as B,a as G,t as N,d as i,B as f,A as R,v as _,j as p,I as j,C as q,D as E,n as k,w as W,e as F,x as H,b as g,m as z,M as I,y as O,z as P,W as $,E as Q,F as L,H as J,J as C,o as b,K}from"./index-da64fe47.js";var D={},Y=B;Object.defineProperty(D,"__esModule",{value:!0});var S=D.default=void 0,V=Y(A()),X=G,Z=(0,V.default)((0,X.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");S=D.default=Z;const ee=({discussion:e,handleBack:o})=>{const{theme:t,userDiscuss:c}=e,l=N(t);return i(f,{sx:{flexGrow:1},children:i(R,{position:"static",sx:{backgroundColor:"inherit",svg:{fill:"inherit"}},children:i(_,{children:p(f,{sx:{display:"flex",alignItems:"center"},children:[i(j,{sx:{mr:2},onClick:o,children:l?i(q,{color1:l[0],color2:l[1],type:t.split("-")[0]==="linear"?"linear":"radial",id:"ArrowBackIcon",children:i(S,{sx:{fill:"url(#ArrowBackIcon)"}})}):i(S,{sx:{fill:t}})}),i(E,{sx:{mr:2},user:c}),i(k,{variant:"h4",children:"groupName"in c?c.groupName:`${c.firstname} ${c.lastname}`}),i(W,{colorIcons:l,theme:t,currentDiscussion:e})]})})})})},se=({currentDiscussion:e,messageToUser:o,listenTheme:t,handleBack:c,sendMessage:l,...x})=>{const{user:h}=F(),U=H(),v=g.useMemo(()=>(t==null?void 0:t.theme)===e.theme?t:void 0,[t,e]),n=g.useRef(null),{data:a,fetchMore:y,loading:w}=z(I,{variables:{discussionId:e.id},skip:!e.id,notifyOnNetworkStatusChange:!0});g.useEffect(()=>{var d;n.current&&(a!=null&&a.messageTwoUser)&&e.openMessage&&(n.current.scrollTop=a.messageTwoUser.length===20?(d=n.current)==null?void 0:d.scrollHeight:308)},[a,e]),g.useEffect(()=>{o&&a&&!a.messageTwoUser.find(d=>d.id===o.messages[0].id)&&U.writeQuery({data:{messageTwoUser:[...a.messageTwoUser,...o.messages]},query:I,variables:{discussionId:e.id}})},[o,a]);const T=async(d,M,s,r,u)=>{const m=await l(d,M,s,r,u);return a!=null&&a.messageTwoUser&&m&&U.writeQuery({data:{messageTwoUser:[...a.messageTwoUser,...m.messages]},query:I,variables:{discussionId:e.id}}),m};return p(f,{...x,children:[i(ee,{discussion:e,handleBack:c}),p(f,{ref:n,sx:{p:2,height:"90%",overflowY:"auto"},children:[w&&i(f,{sx:{display:"flex",justifyContent:"center"},children:i(O,{color:"primary"})}),a==null?void 0:a.messageTwoUser.map((d,M)=>p(g.Fragment,{children:[i(P,{theme:e.theme,message:d,user:h},d.id),M===0&&i($,{onEnter:()=>y({variables:{cursor:a.messageTwoUser[0].id},updateQuery(s,{fetchMoreResult:r}){return r?{messageTwoUser:[...r.messageTwoUser,...s.messageTwoUser]}:s}})})]},d.id)),v&&p(f,{sx:{display:"flex",justifyContent:"center",alignItems:"center"},children:[p(k,{component:"small",sx:{fontSize:"0.5em",mr:1},children:["Thème changé en"," "]}),i(f,{sx:{width:"10px",height:"10px",background:v.theme,borderRadius:"50%"}})]}),e.writters&&e.writters.length>0&&p(f,{sx:{display:"flex",alignItems:"center"},children:[e.writters.map(d=>i(E,{user:d,sx:{mr:1}})),i(Q,{dotColor:e.theme})]})]}),i(L,{theme:e.theme,sendMessage:T,discussion:e,user:h})]})},re=g.createContext({currentDiscussion:void 0,setCurrentDiscussion:e=>{}}),ie=()=>{const{data:e,messageData:o,writting:t,refetchMessageData:c,user:l,sendMessage:x,listenTheme:h,loading:U,fetchMore:v}=J(),[n,a]=g.useState(),[y,w]=g.useState([]),T=g.useMemo(()=>({currentDiscussion:n,setCurrentDiscussion:a}),[n,a]);g.useEffect(()=>{t!=null&&t.writeMessage&&a(s=>{var r;return(s==null?void 0:s.id)===t.writeMessage.discussionId?t.writeMessage.isWritting?{...s,writters:s.writters?[...s.writters,t.writeMessage.user]:[t.writeMessage.user]}:{...s,writters:(r=s.writters)==null?void 0:r.filter(u=>u.id!==t.writeMessage.user.id)}:s})},[t]);const d=s=>{a({...s,newMessageNbr:0,openMessage:!0,userDiscuss:C(l,s.User,s.Receiver,s.DiscussGroup)})};g.useEffect(()=>{o!=null&&o.getDiscussionCurrentUser&&(e&&w(s=>s.find(r=>r.id===e.messageToUser.id)?s.map(r=>r.id===e.messageToUser.id?{...r,userDiscuss:"firstname"in r.userDiscuss?{...r.userDiscuss,status:r.userDiscuss.status}:r.userDiscuss,newMessageNbr:r.newMessageNbr+1,messages:e.messageToUser.messages}:r):[{...e.messageToUser,newMessageNbr:1,userDiscuss:C(l,e.messageToUser.User,e.messageToUser.Receiver,e.messageToUser.DiscussGroup),openMessage:!1},...s]),t&&w(s=>s.find(r=>r.id===t.writeMessage.discussionId)?s.map(r=>r.id===t.writeMessage.discussionId?{...r,writters:t.writeMessage.isWritting?[t.writeMessage.user]:void 0}:r):s),w(s=>{let r=(o==null?void 0:o.getDiscussionCurrentUser.length)-s.length;if(r>0&&r<o.getDiscussionCurrentUser.length){const u=o.getDiscussionCurrentUser.slice(s.length).map(m=>({...m,newMessageNbr:0,userDiscuss:C(l,m.User,m.Receiver,m.DiscussGroup),openMessage:!1}));return[...s,...u]}else if(r===o.getDiscussionCurrentUser.length)return o.getDiscussionCurrentUser.map(u=>({...u,newMessageNbr:0,userDiscuss:C(l,u.User,u.Receiver,u.DiscussGroup),openMessage:!1}));return s}))},[o,e,t]);const M=()=>{a(void 0)};return i(b,{container:!0,children:n!=null&&n.id?i(b,{item:!0,xs:12,children:n.openMessage&&i(se,{messageToUser:n.id===(e==null?void 0:e.messageToUser.id)?e.messageToUser:void 0,listenTheme:(h==null?void 0:h.listenTheme.id)===n.id?h.listenTheme:void 0,handleBack:M,currentDiscussion:n,sendMessage:x,sx:{height:"86vh"}})}):i(b,{item:!0,xs:12,sx:{p:2},children:i(re.Provider,{value:T,children:i(K,{loading:U,fetchMore:v,sendMessage:x,discussions:y,onSelect:d,refetchMessageData:c,sx:{height:"73vh"}})})})})};export{re as MessageContext,ie as default};
